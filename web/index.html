<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>the game</title>
	<link rel="stylesheet" href="xterm.css">
	<script src="https://unpkg.com/xterm"></script>
	<script src="wasm_exec.js"></script>
</head>
<body>
	<main>
		<div id="terminal"></div>
    	<script>
	        	var term = new Terminal({rows: 25, cols: 80});
	        	term.open(document.getElementById('terminal'));
	        	term.write('Loading... please wait :-)')

	        	const go = new Go();
	        				// WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
	        				// 	go.run(result.instance);
	        				// });

    			var xhr = new XMLHttpRequest();
    			xhr.responseType = "arraybuffer";
				xhr.open("GET", "main.wasm");
				var lastprogress = 0;
				xhr.onprogress = function(evt) {
					var prog = Math.floor(event.loaded/1000);
					if (prog > lastprogress) {
						term.write("\r\nDownloaded: " + prog + "KB")
						lastprogress = prog;
					}
				}
				xhr.onload = function() {
					if (xhr.status == 200) {
						term.write("\r\nStarting game, please wait...")
						WebAssembly.instantiate(xhr.response, go.importObject).then(obj => {
			        	    go.run(obj.instance);
			        	    term.focus();
			        	});
					} else {
						alert("failed dl")
					}
				}
				xhr.send(null);


	        	// fetch('main.wasm').then(response => 
	        	// 	response.arrayBuffer()
	        	// ).then(bytes => 
	        	//   WebAssembly.instantiate(bytes, go.importObject)
	        	// ).then(obj => {
	        	//     go.run(obj.instance);
	        	//     term.focus();
	        	// });
    	</script>
	</main>
</body>
</html>